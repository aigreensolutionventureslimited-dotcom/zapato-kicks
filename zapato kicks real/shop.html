<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Collection | Zapato Kicks</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card-bg: #0f0f0f; --accent: #c5a059; --text: #ffffff; --glass: rgba(255, 255, 255, 0.03); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        nav { position: fixed; top: 0; width: 100%; padding: 25px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(20px); z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { font-family: 'Syne', sans-serif; font-size: 1.5rem; text-decoration: none; color: #fff; font-weight: 800; }
        .logo span { color: var(--accent); }
        .bag-trigger { cursor: pointer; font-weight: 600; letter-spacing: 1px; }
        .shop-header { padding: 160px 5% 40px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 40px; padding: 0 5% 100px; }
        .product-card { background: var(--card-bg); border-radius: 30px; padding: 25px; border: 1px solid rgba(255,255,255,0.03); }
        .product-card img { width: 100%; height: 280px; object-fit: contain; margin-bottom: 20px; }
        .qty-input-group { display: flex; align-items: center; gap: 10px; margin: 15px 0; background: #000; padding: 5px; border-radius: 12px; width: fit-content; }
        .qty-btn { background: #222; border: none; color: white; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; }
        .qty-val { font-weight: 600; min-width: 20px; text-align: center; }
        .price { font-weight: 800; font-size: 1.3rem; }
        .add-cart-btn { background: var(--accent); border: none; padding: 12px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; color: #000; }
        .cart-sidebar { position: fixed; right: -450px; top: 0; width: 450px; height: 100%; background: #000; z-index: 2000; padding: 40px; transition: 0.6s cubic-bezier(0.77, 0, 0.175, 1); box-shadow: -20px 0 60px rgba(0,0,0,0.8); overflow-y: auto; }
        .cart-sidebar.open { right: 0; }
        .cart-item { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; border-bottom: 1px solid #111; padding-bottom: 15px; }
        .cart-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .shipping-form input, .shipping-form textarea { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid #222; color: white; border-radius: 10px; margin-bottom: 10px; font-family: inherit; }
        .checkout-btn { width: 100%; padding: 20px; background: var(--accent); color: #000; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; margin-top: 20px; }
        @media (max-width: 500px) { .cart-sidebar { width: 100%; right: -100%; } }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">ZAPATO<span>KICKS</span></a>
        <div class="bag-trigger" onclick="toggleCart()">BAG (<span id="bag-count">0</span>)</div>
    </nav>

    <header class="shop-header">
        <h1 style="font-family: 'Syne'; font-size: 3rem;">Our Collection</h1>
    </header>

    <main class="grid" id="shop-grid"></main>

    <div id="cart-sidebar" class="cart-sidebar">
        <h2 style="font-family: 'Syne'; margin-bottom: 30px;">YOUR BAG</h2>
        <div id="cart-items-container"></div>
        <div class="shipping-form" style="margin-top: 20px; border-top: 1px solid #222; padding-top: 20px;">
            <h4 style="color: var(--accent); margin-bottom: 15px; font-size: 0.8rem; letter-spacing: 1px;">SHIPPING DETAILS</h4>
            <input type="text" id="cust-name" placeholder="Full Name">
            <input type="email" id="cust-email" placeholder="Email Address">
            <textarea id="cust-address" placeholder="Complete Shipping Address" rows="3"></textarea>
        </div>
        <div style="margin-top: 30px; padding-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 800;">
                <span>Total:</span>
                <span id="cart-total" style="color: var(--accent);">₦0</span>
            </div>
            <button class="checkout-btn" onclick="validateAndPay()">PAY & SEND TO WHATSAPP</button>
            <button onclick="toggleCart()" style="width: 100%; margin-top: 15px; background: transparent; color: #444; border: none; cursor: pointer;">Close Bag</button>
        </div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const _supabase = supabase.createClient('https://rvfuenrggxverrnnmcet.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2ZnVlbnJnZ3h2ZXJybm5tY2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4Njc2MTcsImV4cCI6MjA4MzQ0MzYxN30.aKCaWeXR1Le68waDqG_UHiOOZpkZYNC2FTTMutY-CqI');
        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('zk_cart')) || [];

        async function loadShopData() {
            const { data, error } = await _supabase.from('products').select('*').order('created_at', { ascending: false });
            if (error) return;
            allProducts = data;
            displayProducts(allProducts);
        }

        function displayProducts(items) {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = items.map(p => `
                <div class="product-card">
                    <img src="${p.image_url}" alt="${p.name}">
                    <h3>${p.name}</h3>
                    <p class="price">₦${p.price.toLocaleString()}</p>
                    <div class="qty-input-group">
                        <button class="qty-btn" onclick="changeQtyUI(${p.id}, -1)">-</button>
                        <span class="qty-val" id="qty-${p.id}">1</span>
                        <button class="qty-btn" onclick="changeQtyUI(${p.id}, 1)">+</button>
                    </div>
                    <button class="add-cart-btn" onclick="addToCart(${p.id})">ADD TO BAG</button>
                </div>
            `).join('');
        }

        function changeQtyUI(id, delta) {
            const el = document.getElementById(`qty-${id}`);
            let val = parseInt(el.innerText) + delta;
            if (val < 1) val = 1;
            el.innerText = val;
        }

        function addToCart(id) {
            const product = allProducts.find(p => p.id === id);
            const selectedQty = parseInt(document.getElementById(`qty-${id}`).innerText);
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) { existingItem.quantity += selectedQty; } 
            else { cart.push({ ...product, quantity: selectedQty }); }
            localStorage.setItem('zk_cart', JSON.stringify(cart));
            updateCartUI();
            toggleCart(true);
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <img src="${item.image_url}">
                    <div style="flex-grow: 1;">
                        <h4 style="font-size: 0.9rem;">${item.name} (x${item.quantity})</h4>
                        <p style="color: var(--accent); font-size: 0.85rem;">₦${(item.price * item.quantity).toLocaleString()}</p>
                    </div>
                    <button onclick="removeFromCart(${index})" style="background:none; border:none; color:#ff4444; cursor:pointer; font-size:1.2rem; font-weight:bold;">&times;</button>
                </div>
            `).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cart-total').innerText = `₦${total.toLocaleString()}`;
            document.getElementById('bag-count').innerText = cart.reduce((sum, i) => sum + i.quantity, 0);
        }

        function removeFromCart(index) { cart.splice(index, 1); localStorage.setItem('zk_cart', JSON.stringify(cart)); updateCartUI(); }
        function toggleCart(open = null) { const sidebar = document.getElementById('cart-sidebar'); if(open === true) sidebar.classList.add('open'); else sidebar.classList.toggle('open'); }

        function validateAndPay() {
            const name = document.getElementById('cust-name').value;
            const email = document.getElementById('cust-email').value;
            const address = document.getElementById('cust-address').value;
            if (!name || !email || !address || cart.length === 0) { return alert("Please fill all details and add items to bag."); }
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const handler = PaystackPop.setup({
                key: 'pk_test_bbfbbbb08d5855f19ed7ecfc9e3bd35a2cbe2289', 
                email: email,
                amount: total * 100, 
                currency: 'NGN',
                callback: function(response) { saveAndSendWhatsApp(name, email, address, total, response.reference); },
                onClose: function() { alert('Transaction was not completed.'); }
            });
            handler.openIframe();
        }

        async function saveAndSendWhatsApp(name, email, address, total, ref) {
            // 1. Save to Supabase Vault
            await _supabase.from('orders').insert([{
                customer_name: name,
                customer_email: email,
                shipping_address: address,
                amount: total,
                items: cart,
                reference: ref,
                status: 'Paid'
            }]);

            // 2. Generate WhatsApp Message
            let itemDetails = cart.map(i => `- ${i.name} (x${i.quantity})`).join('%0A');
            const message = encodeURIComponent(`*ZAPATO KICKS RECEIPT*\n\n` +
                            `*Order Ref:* ${ref}\n` +
                            `*Customer:* ${name}\n` +
                            `*Address:* ${address}\n\n` +
                            `*Items Ordered:*\n${cart.map(i => `- ${i.name} (x${i.quantity})`).join('\n')}\n\n` +
                            `*Total Paid:* ₦${total.toLocaleString()}`);

            // 3. Redirect to WhatsApp
            const whatsappNumber = "2349150437685";
            window.open(`https://wa.me/2349061996801?text=${message}`, '_blank');
            
            // Clear cart
            localStorage.removeItem('zk_cart');
            location.reload();
        }

        loadShopData();
        updateCartUI();
    </script>
</body>
</html>